# V2 치료 문장 생성 시스템 가이드

## 개요

V2 시스템은 아동 언어치료사를 위한 맞춤형 치료 문장 생성 시스템입니다.
진단 유형과 치료 접근법에 따라 다른 전략으로 문장을 생성합니다.

---

## 1. 진단별 치료 접근법

### 선택 가능한 조합

| 진단 | 치료 접근법 | 목표 | 음소 타겟 |
|------|------------|------|----------|
| **SSD** (말소리장애) | Minimal Pairs (최소대립쌍) | 음소 대조 인식 | ✅ 필수 |
| **SSD** | Maximal Oppositions (최대대립) | 최대 음소 대조 | ✅ 필수 |
| **SSD** | Complexity (복잡성) | 난이도별 음소 연습 | ✅ 필수 |
| **ASD** (자폐스펙트럼) | Core Vocabulary (핵심어휘) | 기능적 의사소통 | ❌ 없음 |
| **LD** (언어발달지연) | Core Vocabulary (핵심어휘) | 기능적 의사소통 | ❌ 없음 |

### UI 동작

```
┌─────────────────────────────────────────────────────────┐
│  1. 진단군 선택                                          │
│     [SSD] [ASD] [LD]                                    │
│                                                         │
│  2. 치료 접근법 (진단에 따라 자동 필터링)                   │
│     SSD 선택 시: [최소대립쌍] [최대대립] [복잡성]           │
│     ASD/LD 선택 시: [핵심어휘]                            │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 치료 접근법별 상세

### 2.1 Minimal Pairs (최소대립쌍) - SSD용

**목적**: 하나의 음소만 다른 단어 쌍을 통해 음소 변별력 향상

**생성 형태**:
```json
{
  "sets": [
    {
      "target_word": "라면",
      "contrast_word": "나면",
      "target_sentence": {"tokens": ["맛있는", "라면을", "먹어요"]},
      "contrast_sentence": {"tokens": ["봄이", "나면", "좋아요"]}
    }
  ]
}
```

**UI 설정**:
- 목표 음소: ㄱ, ㄴ, ㄷ, ㄹ, ㅁ, ㅂ, ㅅ, ㅈ, ㅊ, ㅋ, ㅌ, ㅍ, ㅎ
- 음소 위치: 초성 / 종성 / 전체
- 최소 출현 횟수: 1~3회

**예시 출력**:
| 목표 단어 | 대조 단어 | 목표 문장 | 대조 문장 |
|----------|----------|----------|----------|
| 달 | 탈 | 밝은 달이 떴어요 | 가면 탈을 썼어요 |
| 불 | 풀 | 모닥불이 따뜻해요 | 푸른 풀이 자라요 |

---

### 2.2 Maximal Oppositions (최대대립) - SSD용

**목적**: 최대한 다른 음소 쌍으로 대조하여 음소 체계 재구성

**생성 형태**: Minimal Pairs와 동일

**특징**:
- 조음 위치, 조음 방법이 최대한 다른 음소 쌍 사용
- 예: /ㅂ/ vs /ㅎ/, /ㄱ/ vs /ㅁ/

---

### 2.3 Complexity (복잡성 접근법) - SSD용

**목적**: 복잡한 음운 환경에서 음소를 연습하여 일반화 촉진

**생성 형태**:
```json
{
  "items": [
    {
      "tokens": ["라면을", "맛있게", "먹어요"],
      "difficulty": "easy",
      "target_analysis": {
        "phoneme": "ㄹ",
        "position": "onset",
        "environment": "어두 초성, 모음 앞",
        "complexity_reason": "단순한 음운 환경"
      }
    }
  ]
}
```

**난이도 분류**:
| 난이도 | 설명 | 예시 |
|--------|------|------|
| easy | 단순 위치, 쉬운 주변 음소 | 어두 초성 + 모음 |
| medium | 자음군, 약간 복잡한 환경 | 어중 위치, 자음 연쇄 |
| hard | 복잡한 자음군, 어려운 환경 | 자음군 + 종성 연쇄 |

---

### 2.4 Core Vocabulary (핵심어휘) - ASD/LD용

**목적**: 고빈도 기능어를 사용한 의사소통 능력 향상

**핵심 어휘 목록**:
| 한국어 | 영어 | 기능 |
|--------|------|------|
| 더 | more | 요청 |
| 또 | again | 반복 요청 |
| 아니 | no | 거부 |
| 네 | yes | 수락 |
| 싫어 | don't want | 거부 |
| 줘 | give | 요청 |
| 이거 | this | 지시 |
| 저거 | that | 지시 |
| 뭐 | what | 질문 |
| 어디 | where | 질문 |

**생성 형태**:
```json
{
  "items": [
    {"core_word": "줘", "tokens": ["엄마", "물", "줘"]},
    {"core_word": "더", "tokens": ["까까", "더", "줘"]},
    {"core_word": "또", "tokens": ["또", "하고", "싶어"]}
  ]
}
```

**특징**:
- ⚠️ **음소 타겟 없음** - 기능적 의사소통이 목표
- 모든 문장에 핵심 어휘 1개 이상 필수 포함
- 자연스러운 일상 표현 중심

**UI 표시**:
```
┌─────────────────────────────────────────────────────────┐
│  2. 핵심 어휘                                            │
│  ┌─────────────────────────────────────────────────────┐│
│  │ 핵심어휘 접근법은 기능적 의사소통에 집중합니다.        ││
│  │ 음소 목표 대신 아래 핵심 단어들을 자연스럽게          ││
│  │ 사용하는 문장을 생성합니다.                          ││
│  │                                                     ││
│  │ [더] [또] [아니] [네] [싫어] [줘] [이거] [저거]...   ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
```

---

## 3. 공통 설정 옵션

### 3.1 문장 길이 (어절 수)

| 어절 수 | 권장 연령 | 예시 |
|--------|----------|------|
| 2 | 3세 | "물 줘" |
| 3 | 3-4세 | "엄마 물 줘" |
| 4 | 4-5세 | "엄마 물 좀 줘" |
| 5 | 5-6세 | "엄마 시원한 물 좀 줘" |
| 6 | 6-7세 | "엄마 냉장고에 있는 물 좀 줘" |

### 3.2 주제

| 주제 | 아이콘 | 관련 어휘 |
|------|--------|----------|
| 일상 | 🏠 | 먹기, 자기, 놀기, 옷 입기 |
| 음식 | 🍽️ | 과일, 채소, 간식, 음료 |
| 동물 | 🐶 | 강아지, 고양이, 토끼, 새 |
| 가족 | 👨‍👩‍👧 | 엄마, 아빠, 형제, 조부모 |

### 3.3 의사소통 기능

| 기능 | 설명 | 예시 |
|------|------|------|
| 요청 (request) | 물건, 도움, 행동 요청 | "물 주세요" |
| 거절 (reject) | 싫어요, 아니요 표현 | "안 먹어" |
| 도움 (help) | 도움 요청 | "열어 주세요" |
| 선택 (choice) | 이것/저것 선택 | "이거 할래" |
| 주목 (attention) | 관심 끌기 | "엄마 봐봐" |
| 질문 (question) | 뭐, 어디, 왜 | "이거 뭐야?" |

### 3.4 연령별 어휘 가이드라인

| 연령 | 어휘 특징 | 문장 형태 |
|------|----------|----------|
| 3세 | 엄마, 아빠, 물, 밥, 까까, 의성어 | 1-2단어 조합 |
| 4세 | 기본 가족, 음식, 동물 | 주어+서술어 |
| 5세 | 유치원, 친구, 선생님 | 기본 문장, 연결어미 |
| 6세 | 다양한 명사/형용사/부사 | 복합 문장, 시제 |
| 7세 | 학교 어휘, 추상 개념 | 복잡한 구조, 비유 |

---

## 4. 생성 파이프라인 플로우

```
┌──────────────────────────────────────────────────────────────┐
│                      사용자 요청                              │
│  {language, age, count, target?, sentenceLength,             │
│   diagnosis, therapyApproach, theme?, function?}             │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  1️⃣ GENERATE - 후보 문장 생성                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ • 치료 접근법에 맞는 프롬프트 생성                        │ │
│  │ • GPT-5.2 호출 (low reasoning, 120s timeout)            │ │
│  │ • batch_size = (요청 수 - 확보된 수) × 3                 │ │
│  │ • JSON 파싱 → 문장 리스트 추출                           │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  🛡️ GUARDRAIL - 안전 필터링                                  │
│  • 부적절한 내용 필터링                                       │
│  • 아동 안전성 검사                                          │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  2️⃣ VALIDATE - 하드 제약 검증                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ✓ 어절 수 검사 (정확히 sentenceLength개)                 │ │
│  │ ✓ 음소 검사 (SSD만, core_vocabulary는 스킵)              │ │
│  │   - 목표 음소 포함 여부                                  │ │
│  │   - 지정 위치(초성/종성) 확인                            │ │
│  │   - 최소 출현 횟수 확인                                  │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  3️⃣ SCORE - 품질 점수 부여                                   │
│  • 어휘 다양성                                               │
│  • 문장 자연스러움                                           │
│  • 연령 적합성                                               │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  4️⃣ DIVERSIFY - 다양성 확보                                  │
│  • 중복 제거                                                 │
│  • 유사 문장 필터링                                          │
│  • 상위 N개 선택                                             │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                      최종 응답                                │
│  {                                                           │
│    "success": true,                                          │
│    "data": {                                                 │
│      "items": [TherapyItemV2, ...],                         │
│      "meta": {                                               │
│        "requestedCount": 10,                                 │
│        "generatedCount": 10,                                 │
│        "averageScore": 0.85,                                 │
│        "processingTimeMs": 3500                              │
│      }                                                       │
│    }                                                         │
│  }                                                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. API 요청/응답 예시

### 5.1 SSD - Minimal Pairs 요청

```json
// POST /api/v2/generate
{
  "language": "ko",
  "age": 5,
  "count": 10,
  "target": {
    "phoneme": "ㄹ",
    "position": "onset",
    "minOccurrences": 1
  },
  "sentenceLength": 4,
  "diagnosis": "SSD",
  "therapyApproach": "minimal_pairs",
  "theme": "daily",
  "communicativeFunction": "request"
}
```

### 5.2 ASD - Core Vocabulary 요청

```json
// POST /api/v2/generate
{
  "language": "ko",
  "age": 3,
  "count": 10,
  "sentenceLength": 3,
  "diagnosis": "ASD",
  "therapyApproach": "core_vocabulary",
  "communicativeFunction": "request"
}
// ⚠️ target 필드 없음!
```

### 5.3 응답 예시

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "text": "엄마 물 줘",
        "target": null,
        "matchedWords": [],
        "wordCount": 3,
        "score": 0.92,
        "diagnosis": "ASD",
        "approach": "core_vocabulary",
        "theme": null,
        "function": "request"
      },
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "text": "까까 더 줘",
        "target": null,
        "matchedWords": [],
        "wordCount": 3,
        "score": 0.88,
        "diagnosis": "ASD",
        "approach": "core_vocabulary",
        "theme": null,
        "function": "request"
      }
    ],
    "meta": {
      "requestedCount": 10,
      "generatedCount": 10,
      "averageScore": 0.87,
      "processingTimeMs": 2847
    }
  }
}
```

---

## 6. 에러 처리

| 에러 코드 | 설명 | 대응 |
|----------|------|------|
| INVALID_REQUEST | 잘못된 요청 파라미터 | 입력값 확인 |
| GENERATION_FAILED | LLM 생성 실패 | 재시도 |
| INSUFFICIENT_RESULTS | 충분한 문장 미생성 | 조건 완화 후 재시도 |
| RATE_LIMITED | API 호출 제한 | 잠시 후 재시도 |
| SERVICE_UNAVAILABLE | 서비스 불가 | 서버 상태 확인 |

---

## 7. 성능 최적화

- **Reasoning Effort**: `low` 사용 (빠른 응답)
- **Batch Size**: 요청의 3배수로 생성하여 검증 통과율 보장
- **Retry**: 최대 3회 재시도
- **Timeout**: 120초

---

## 8. 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2025-01-22 | core_vocabulary에서 음소 검증 스킵 |
| 2025-01-22 | target 필드 optional로 변경 |
| 2025-01-22 | UI에서 core_vocabulary 선택 시 핵심어휘 안내 표시 |
